<!DOCTYPE html>
<html>
<head>
    <title>Dự báo Nhiệt độ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <div class="container mt-5">
        <h2 class="mb-4">Dự báo Nhiệt độ</h2>
        
        <div class="row">
            <div class="col-md-4">
                <form id="predict-form">
                    <div class="mb-3" id="station-group">
                        <label for="station" class="form-label">Chọn trạm:</label>
                        <select class="form-select" id="station" name="station" required>
                            {% for station in stations %}
                                <option value="{{ loop.index0 }}">
                                    Trạm {{ loop.index }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Chọn kiểu dữ liệu đầu vào:</label>
                        <div>
                            <input type="radio" id="option-default" name="input-option" value="default" checked>
                            <label for="option-default">Dự báo 24 ngày tiếp theo cho trạm đã chọn</label>
                        </div>
                        <div>
                            <input type="radio" id="option-random" name="input-option" value="random">
                            <label for="option-random">Tạo dữ liệu ngẫu nhiên</label>
                        </div>
                        <div>
                            <input type="radio" id="option-csv" name="input-option" value="csv">
                            <label for="option-csv">Tải lên file CSV cho trạm đã chọn</label>
                        </div>
                    </div>
                    <div class="mb-3 d-none" id="csv-group">
                        <label for="csv-file" class="form-label">Chọn file CSV:</label>
                        <input type="file" class="form-control" id="csv-file" name="csv-file" accept=".csv">
                    </div>
                    <button type="submit" class="btn btn-primary">Dự báo</button>
                </form>
            </div>
            
            <div class="col-md-8">
                <div id="prediction-plot"></div>
            </div>
        </div>
    </div>

    <script>
        // Ẩn dropdown chọn trạm nếu chọn random
        document.querySelectorAll('input[name="input-option"]').forEach(function(el) {
            el.addEventListener('change', function() {
                document.getElementById('csv-group').classList.toggle('d-none', this.value !== 'csv');
                document.getElementById('station-group').classList.toggle('d-none', this.value === 'random');
            });
        });

        function updateChart(data) {
            Plotly.purge('prediction-plot');
            const dates = data.forecast.map(item => item.DATE);
            const temperatures = data.forecast.map(item => item.TMP_PREDICTED);
            const trace = {
                x: dates,
                y: temperatures,
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Predicted Temperature'
            };
            const layout = {
                title: 'Temperature Forecast',
                xaxis: { title: 'Date', type: 'date' },
                yaxis: { title: 'Temperature (°C)' }
            };
            Plotly.newPlot('prediction-plot', [trace], layout);
        }

        document.getElementById('predict-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            var inputOption = document.querySelector('input[name="input-option"]:checked').value;
            let fetchOptions;

            if (inputOption === 'csv') {
                var stationIndex = document.getElementById('station').value;
                var stations = {{ stations|tojson }};
                var selectedStation = stations[stationIndex];
                var longitude = selectedStation['LONGITUDE'];
                var latitude = selectedStation['LATITUDE'];
                var cluster = selectedStation['cluster'];
                var fileInput = document.getElementById('csv-file');
                if (!fileInput.files.length) {
                    alert('Vui lòng chọn file CSV!');
                    return;
                }
                var formData = new FormData();
                formData.append('csv_file', fileInput.files[0]);
                formData.append('longitude', longitude);
                formData.append('latitude', latitude);
                formData.append('cluster', cluster);
                fetchOptions = {
                    method: 'POST',
                    body: formData
                };
            } else if (inputOption === 'random') {
                fetchOptions = {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ random: true })
                };
            } else {
                // default
                var stationIndex = document.getElementById('station').value;
                var stations = {{ stations|tojson }};
                var selectedStation = stations[stationIndex];
                var longitude = selectedStation['LONGITUDE'];
                var latitude = selectedStation['LATITUDE'];
                fetchOptions = {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        longitude: longitude,
                        latitude: latitude
                    })
                };
            }

            try {
                const response = await fetch('/predict', fetchOptions);
                const data = await response.json();
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }
                updateChart(data);
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while fetching the prediction');
            }
        });
    </script>
</body>
</html>